<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order Confirmation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background: #f6f7f9;
        margin: 0;
        padding: 40px 20px;
        color: #333;
      }

      .container {
        max-width: 1150px;
        margin: auto;
        display: flex;
        flex-direction: column;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        padding: 0 24px 24px 24px;
      }

      .content-wrapper {
        display: flex;
        gap: 24px;
        flex: 1;
      }

      .page-header {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        position: relative;
        padding: 20px 0 30px 0;
      }

      .page-header h2 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
        color: #111827;
      }

      .page-header p {
        color: #6b7280;
        font-size: 1.05rem;
        margin-top: 0;
      }

      .page-header a.btn-back {
        position: absolute;
        left: 0;
        top: 30px;
        font-size: 1.8rem;
        color: #374151;
        transition: color 0.2s ease;
      }

      .page-header a.btn-back:hover {
        color: #007bff;
      }

      .btn-back {
        text-decoration: none;
        transition: color 0.2s ease;
      }

      .left-panel {
        flex: 1;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .right-panel {
        width: 300px;
        background: #fff;
        border-radius: 12px;
        box-shadow: none;
        border: 1px solid #e5e7eb;
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: fit-content;
      }

      .section {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 25px;
        padding-top: 8px;
        margin-top: 0;
        background: #fff;
      }

      .section h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #111827;
      }

      .config-title i {
        color: #111827;
        font-size: 20px;
      }

      .order-code-block {
        background: #f3f4f6;
        padding: 12px;
        border-radius: 8px;
        color: #111827;
        margin-top: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 97%;
      }

      .order-code-block .code-label {
        font-size: 16px;
        font-weight: 500;
        color: #6b7280;
      }

      .order-code-block .code-value {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
      }

      .order-code-block label {
        display: none;
      }

      .input-group {
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
        margin-top: 10px;
      }

      .input-field {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 250px;
      }

      .input-field label {
        font-size: 14px;
        color: #6b7280;
      }

      .input-field span {
        color: #ef4444;
      }

      .info-display {
        font-size: 16px;
        font-weight: 500;
        color: #111827;
        padding: 8px 0;
        margin-top: 5px;
      }

      .list-file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 8px;
        background-color: #f3f4f6;
      }

      .list-file-info strong {
        font-size: 15px;
        font-weight: 600;
        display: block;
        color: #111827;
      }

      .list-file-info small {
        font-size: 13px;
        color: #6b7280;
        display: block;
        line-height: 1.4;
      }

      .list-file-price {
        font-size: 15px;
        font-weight: 600;
        color: #111827;
        text-align: right;
      }

      .order-summary-header {
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
        font-size: 18px;
        color: #111827;
      }

      .order-summary-footer {
        border-top: none;
        margin-top: 0;
        padding-top: 0;
        font-size: 14px;
      }

      .order-summary-footer .d-flex {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
      }

      .order-summary-footer .d-flex span:first-child {
        color: #6b7280;
      }

      .order-summary-footer .total-row span:last-child {
        font-size: 1.15rem;
        font-weight: 700;
        color: #111827;
      }

      .order-file-list {
        padding-top: 5px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e5e5e5;
        margin-bottom: 15px;
      }

      .order-file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        background: #f3f4f6;
        border-radius: 6px;
        margin-bottom: 8px;
      }

      .order-file-item .file-name {
        font-weight: 500;
        font-size: 15px;
        color: #111827;
        max-width: 70%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .order-file-item .file-price {
        font-weight: 600;
        font-size: 15px;
        color: #111827;
      }

      .btn-payment {
        background: #0095ff;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 12px;
        font-weight: 600;
        width: 100%;
        cursor: pointer;
        transition: background 0.2s ease;
        margin-top: 15px;
        margin-bottom: 5px;
      }

      .service-benefits {
        font-size: 13px;
        color: #6b7280;
        padding-top: 15px;
        text-align: center;
      }

      .service-benefits ul {
        list-style: none;
        padding-left: 0;
        margin: 0;
        display: inline-block;
      }

      .service-benefits li {
        margin-bottom: 5px;
        position: static;
        padding-left: 0px;
      }

      .service-benefits li::before {
        content: none;
      }

      .deposit-notice {
        background-color: #f5cb4a;
        border: 1px solid #cf5d12;
        border-radius: 8px;
        padding: 10px;
        padding-bottom: 5px;
        margin: 10px 0 10px 0;
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }

      .deposit-notice i {
        font-size: 24px;
        color: #ac2412;
        margin-top: 0px;
      }

      .deposit-notice .text-content strong {
        display: block;
        font-size: 15px;
        font-weight: 600;
        color: #ac2412;
        margin-bottom: 2px;
      }

      .deposit-notice .text-content p {
        font-size: 13px;
        color: #cf5d12;
        margin: 0;
        line-height: 1.4;
      }

      @media (max-width: 768px) {
        body {
          padding: 20px 10px;
        }
        .container {
          flex-direction: column;
          gap: 15px;
          padding: 15px;
        }
        .content-wrapper {
          flex-direction: column;
          gap: 15px;
        }
        .right-panel {
          width: 100%;
          order: -1;
        }
        .page-header {
          padding-left: 30px;
          margin-bottom: 15px;
          align-items: flex-start;
          text-align: left;
        }
        .page-header a.btn-back {
          left: 0;
          top: 50%;
          transform: translateY(-50%);
        }
      }

      /* A11y helper: văn bản chỉ dành cho screen reader */
      .sr-only {
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        padding: 0 !important;
        margin: -1px !important;
        overflow: hidden !important;
        clip: rect(0, 0, 0, 0) !important;
        white-space: nowrap !important;
        border: 0 !important;
      }
    </style>
  </head>

  <body>
    <main role="main">
      <div class="container">
        <div class="page-header">
          <a href="#" class="btn-back" id="backButton"
            ><i class="bx bx-arrow-back"></i
          ></a>
          <h2>Order Confirmation</h2>
          <p>Review your order details before proceeding to payment</p>
        </div>

        <div class="content-wrapper">
          <div class="left-panel">
            <div class="section" id="serviceSection">
              <h3 class="config-title">
                <i class="bx bxs-file"></i> Document Printing
              </h3>
              <div class="order-code-block">
                <span class="code-label">Order Code:</span>
                <span class="code-value">No data</span>
              </div>
            </div>

            <div class="section">
              <h3 class="config-title">
                <i class="bx bx-user"></i> Customer Information
              </h3>
              <div class="input-group">
                <div class="input-field">
                  <label>Full Name <span>*</span></label>
                  <div class="info-display">No data</div>
                </div>
                <div class="input-field">
                  <label>Email <span>*</span></label>
                  <div class="info-display">No data</div>
                </div>
              </div>
            </div>

            <div class="section">
              <h3 class="config-title">
                <i class="bx bxs-file"></i> List of Documents to Print
              </h3>
              <div id="fileListConfirmation">
                <!-- Content will be dynamically rendered -->
              </div>
            </div>
          </div>

          <div class="right-panel">
            <div>
              <div class="order-summary-header">
                <i class="bx bx-list-ul"></i> <span>Order Summary</span>
              </div>

              <div class="order-file-list">
                <!-- Content will be dynamically rendered -->
              </div>
            </div>

            <div class="order-summary-footer">
              <div class="d-flex">
                <span>Number of Documents:</span>
                <span id="fileCountDisplay">0 documents</span>
              </div>
              <div class="d-flex total-row">
                <span>Total:</span>
                <span id="totalPriceDisplay">0₫</span>
              </div>

              <button class="btn-payment">Proceed to Payment</button>

              <div class="service-benefits">
                <ul>
                  <li>Completion Time: 2-5 business days</li>
                  <li>Email notification upon completion</li>
                  <li>Support for in-store and online payment</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script>
        function formatCurrency(amount) {
          if (typeof amount !== "number" || isNaN(amount)) return "0₫";
          return amount.toLocaleString("vi-VN") + "₫";
        }

        function buildFileDetails(file) {
          if (file.type === "Photo") {
            // Details for photo printing
            let details = `${file.pages} photos × ${file.copies} copies`;
            details += `<br>${file.size} • ${file.mode}${
              file.borderless ? " • Borderless" : ""
            }`;
            return details;
          } else {
            // Details for document printing
            let sideText = "N/A";
            if (file.side) {
              let sideValue = String(file.side).toLowerCase();
              if (
                sideValue.includes("1 side") ||
                sideValue.includes("single") ||
                sideValue.includes("1 page") ||
                sideValue.includes("1-sided") ||
                sideValue === "1"
              ) {
                sideText = "Single-sided";
              } else if (
                sideValue.includes("2 side") ||
                sideValue.includes("double") ||
                sideValue.includes("2 page") ||
                sideValue.includes("2-sided") ||
                sideValue === "2"
              ) {
                sideText = "Double-sided";
              } else {
                sideText = file.side;
              }
            }
            let details = `${file.pages} pages × ${file.copies} copies`;
            details += `<br>${file.size} • ${sideText} • ${file.mode}`;
            if (file.type === "Thesis/Report") {
              details += `${file.binding ? " • Bound" : ""}${
                file.coverPage ? " • Cover Page" : ""
              }`; // Sửa từ file.cover thành file.coverPage
            }
            return details;
          }
        }

        function displayDepositNotice(totalPrice) {
          const DEPOSIT_THRESHOLD = 100000;
          const orderSummaryFooter = document.querySelector(
            ".order-summary-footer"
          );
          const paymentButton = document.querySelector(".btn-payment");

          const existingNotice = document.getElementById("depositNotice");
          if (existingNotice) {
            existingNotice.remove();
          }

          if (
            totalPrice >= DEPOSIT_THRESHOLD &&
            orderSummaryFooter &&
            paymentButton
          ) {
            const noticeHtml = `
            <div id="depositNotice" class="deposit-notice">
                <i class='bx bxs-bell-ring'></i>
                <div class="text-content">
                    <strong>Important Notice</strong>
                    <p>Orders above ${formatCurrency(
                      DEPOSIT_THRESHOLD
                    )} require a 50% deposit before processing.</p>
                </div>
            </div>
        `;
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = noticeHtml.trim();
            const depositNoticeElement = tempDiv.firstChild;
            orderSummaryFooter.insertBefore(
              depositNoticeElement,
              paymentButton
            );
          }
        }

        document.addEventListener("DOMContentLoaded", function () {
          const orderDataString = localStorage.getItem("printOrderData"); // Sửa từ sessionStorage thành localStorage
          const fileListConfirmation = document.getElementById(
            "fileListConfirmation"
          );
          const orderFileList = document.querySelector(".order-file-list");
          const totalPriceDisplay =
            document.getElementById("totalPriceDisplay");
          const fileCountDisplay = document.getElementById("fileCountDisplay");
          const customerNameDisplay = document.querySelector(
            ".input-group .input-field:nth-child(1) .info-display"
          );
          const customerEmailDisplay = document.querySelector(
            ".input-group .input-field:nth-child(2) .info-display"
          );
          const orderCodeDisplay = document.querySelector(
            ".order-code-block .code-value"
          );
          const backButton = document.getElementById("backButton");
          const serviceSection = document.getElementById("serviceSection");
          const fileListSection = fileListConfirmation
            ? fileListConfirmation.closest(".section")
            : null;
          const leftPanel = document.querySelector(".left-panel");

          // Đặt backButton.href trực tiếp thành Service_Print.html
          if (backButton) {
            backButton.href = "/service/print";
          }

          if (fileListConfirmation) fileListConfirmation.innerHTML = "";
          if (orderFileList) orderFileList.innerHTML = "";

          if (orderDataString && fileCountDisplay && totalPriceDisplay) {
            const orderData = JSON.parse(orderDataString);

            // Determine service type based on orderCode
            const isPhotoOrder =
              orderData.orderCode && orderData.orderCode.startsWith("PHOTO-");
            const serviceTitle = isPhotoOrder
              ? "Photo Printing"
              : "Document Printing";
            const serviceIcon = isPhotoOrder ? "bxs-image" : "bxs-file";
            const fileListTitle = isPhotoOrder
              ? "List of Photos to Print"
              : "List of Documents to Print";
            const fileListIcon = isPhotoOrder ? "bxs-image-alt" : "bxs-file";
            const countLabel = isPhotoOrder ? "photos" : "documents";

            // Update service section title and icon
            if (serviceSection) {
              const serviceHeader =
                serviceSection.querySelector(".config-title");
              if (serviceHeader) {
                serviceHeader.innerHTML = `<i class='bx ${serviceIcon}'></i> ${serviceTitle}`;
              }
            }

            // Update file list section title and icon
            if (fileListSection) {
              const fileListHeader =
                fileListSection.querySelector(".config-title");
              if (fileListHeader) {
                fileListHeader.innerHTML = `<i class='bx ${fileListIcon}'></i> ${fileListTitle}`;
              }
            }

            // Display customer information
            if (customerNameDisplay)
              customerNameDisplay.textContent =
                orderData.customer.name || "N/A";
            if (customerEmailDisplay)
              customerEmailDisplay.textContent =
                orderData.customer.email || "N/A";
            if (orderCodeDisplay)
              orderCodeDisplay.textContent =
                orderData.orderCode || (isPhotoOrder ? "PHOTO-N/A" : "DOC-N/A");

            // Handle special requests
            if (
              orderData.specialRequest &&
              orderData.specialRequest.trim() !== "" &&
              leftPanel &&
              fileListSection
            ) {
              const specialRequestSection = document.createElement("div");
              specialRequestSection.classList.add("section");
              specialRequestSection.style.marginTop = "20px";
              specialRequestSection.innerHTML = `
                <h3 class="config-title"><i class='bx bx-message-square-detail'></i> Special Requests</h3>
                <div class="info-display" style="white-space: pre-wrap; margin-top: 0; font-size: 15px;">${orderData.specialRequest}</div>
            `;
              leftPanel.insertBefore(specialRequestSection, fileListSection);
            }

            // Display file details
            orderData.files.forEach((file) => {
              const detailsHtml = buildFileDetails(file);

              if (fileListConfirmation) {
                const detailItem = document.createElement("div");
                detailItem.classList.add("list-file-item");
                detailItem.innerHTML = `
                    <div class="list-file-info">
                        <strong>${file.name}</strong>
                        <small>${detailsHtml}</small>
                    </div>
                    <div class="list-file-price">${formatCurrency(
                      file.price
                    )}</div>
                `;
                fileListConfirmation.appendChild(detailItem);
              }

              if (orderFileList) {
                const summaryItem = document.createElement("div");
                summaryItem.classList.add("order-file-item");
                summaryItem.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <span class="file-price">${formatCurrency(
                      file.price
                    )}</span>
                `;
                orderFileList.appendChild(summaryItem);
              }
            });

            // Display order summary
            const count = orderData.summary.fileCount;
            const totalAmount = orderData.summary.totalPrice;
            fileCountDisplay.textContent = `${count} ${
              isPhotoOrder
                ? count > 1
                  ? "photos"
                  : "photo"
                : count > 1
                ? "documents"
                : "document"
            }`;
            totalPriceDisplay.textContent = formatCurrency(totalAmount);

            displayDepositNotice(totalAmount);
          } else {
            // Default to 'documents' if no order data is available
            const countLabel = "documents";
            if (fileListConfirmation)
              fileListConfirmation.innerHTML = `<p style="text-align: center; color: #999;">No order data found. Please return to the ${countLabel} printing page.</p>`;
            if (totalPriceDisplay) totalPriceDisplay.textContent = "0₫";
            if (fileCountDisplay)
              fileCountDisplay.textContent = `0 ${countLabel}`;
          }

          // Lưu previousPage cho Order_Payment.html (sửa Oder thành Order)
          localStorage.setItem("previousPage", "/order/confirm");

          // Xử lý nút Proceed to Payment
          const paymentButton = document.querySelector(".btn-payment");
          if (!paymentButton) {
            console.error("Không tìm thấy nút btn-payment");
            return;
          }

          paymentButton.addEventListener("click", async function () {
            const orderDataString = localStorage.getItem("printOrderData");
            if (!orderDataString) {
              alert("Không tìm thấy dữ liệu đơn hàng!");
              return;
            }

            let orderData;
            try {
              orderData = JSON.parse(orderDataString);
            } catch (e) {
              console.error("Lỗi parse printOrderData:", e);
              alert("Lỗi khi xử lý dữ liệu đơn hàng!");
              return;
            }

            const isPhotoOrder =
              orderData.orderCode &&
              String(orderData.orderCode).startsWith("PHOTO-");

            // ẢNH: nếu đã có backendOrderId thì KHÔNG tạo lại
            if (isPhotoOrder) {
              const existingId = localStorage.getItem("backendOrderId");
              if (existingId) {
                // Đã có đơn thật → sang trang thanh toán
                window.location.href = "/order/payment";
                return;
              }
              try {
                // Chuẩn hóa size code từ "10 x 15 cm" -> "10x15"
                const normalizeSizeCode = (s) =>
                  String(s || "")
                    .replace(/\s+/g, "")
                    .replace(/cm$/i, "")
                    .replace(/[^0-9x]/gi, "") || "10x15";

                // Chuẩn body
                const body = {
                  customerId: orderData.customer?.id || 1, // nếu chưa có id user thì tạm 1
                  note: orderData.specialRequest || null,
                  files: (orderData.files || []).map((f) => ({
                    name: f.name,
                    sizeCode: normalizeSizeCode(f.size || "10x15"),
                    paper: f.mode || "Glossy", // 'Glossy' | 'Matte' | 'Premium'
                    borderless: !!f.borderless, // true/false
                    copies: Number(f.copies || 1),
                    uploadedFileId: f.fileId || null, // nếu FE có upload trước đó
                  })),
                };

                const resp = await fetch("/api/orders/photo", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  credentials: "include",
                  body: JSON.stringify(body),
                });

                const created = await resp.json();
                if (!resp.ok || !created?.success) {
                  console.error("Create photo order failed:", created);
                  alert("Tạo đơn in ảnh thất bại. Vui lòng thử lại!");
                  return;
                }

                // Lưu orderId backend để trang Payment đọc lại tổng tiền từ DB
                localStorage.setItem("backendOrderId", created.order.id);

                // (tuỳ) Lưu dữ liệu gốc để show ở payment nếu cần
                localStorage.setItem(
                  "currentOrderData",
                  JSON.stringify(orderData)
                );

                // Điều hướng
                window.location.href = "/order/payment";
              } catch (err) {
                console.error(err);
                alert("Có lỗi khi tạo đơn ảnh trên server!");
              }
              return;
            }

            // TÀI LIỆU: giữ flow cũ của bạn (không gọi backend)
            localStorage.setItem("currentOrderData", JSON.stringify(orderData));
            window.location.href = "/order/payment";
          });
        });
      </script>
    </main>
  </body>
</html>
