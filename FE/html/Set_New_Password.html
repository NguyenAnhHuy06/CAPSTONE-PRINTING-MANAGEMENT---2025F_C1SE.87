<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Set New Password</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

  <link rel="stylesheet" href="../css/Set_New_Password.css" />
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <style>
    /* A11y helper: văn bản chỉ dành cho screen reader */
    .sr-only {
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0, 0, 0, 0) !important;
      white-space: nowrap !important;
      border: 0 !important;
    }
  </style>
</head>

<body>
  <main role="main">
    <div class="container">
      <form id="resetForm" novalidate>
        <i class="bx bx-lock-open lock-icon"></i>
        <h2>Set New Password</h2>
        <p class="desc">Create a new password to secure your account.</p>

        <div class="input-box">
          <i class="bx bx-lock"></i>
          <input type="password" id="newPass" placeholder="New Password" autocomplete="new-password" minlength="8"
            required />
          <i class="bx bx-eye-slash toggle-pass" id="toggleNewPass" role="button" tabindex="0"
            aria-label="Toggle password visibility"></i>
        </div>

        <div class="input-box">
          <i class="bx bx-lock"></i>
          <input type="password" id="confirmPass" placeholder="Confirm New Password" autocomplete="new-password"
            minlength="8" required />
          <i class="bx bx-eye-slash toggle-pass" id="toggleConfirmPass" role="button" tabindex="0"
            aria-label="Toggle password visibility"></i>
        </div>

        <div id="errorMsg" class="error-msg" role="alert" aria-live="assertive"></div>

        <button class="btn" id="confirmBtn" type="submit">Confirm</button>
      </form>
    </div>

    <script>
      function togglePassword(toggleId, inputId) {
        const toggle = document.getElementById(toggleId);
        const input = document.getElementById(inputId);
        toggle.addEventListener("click", () => {
          const type =
            input.getAttribute("type") === "password" ? "text" : "password";
          input.setAttribute("type", type);
          toggle.classList.toggle("bx-eye");
          toggle.classList.toggle("bx-eye-slash");
        });
      }

      // Enable keyboard accessibility for toggle icons
      document.querySelectorAll(".toggle-pass").forEach((el) => {
        el.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.code === "Space" || e.keyCode === 32) {
            e.preventDefault();
            el.click();
          }
        });
      });

      togglePassword("toggleNewPass", "newPass");
      togglePassword("toggleConfirmPass", "confirmPass");

      const btn = document.getElementById("confirmBtn");
      const errorMsg = document.getElementById("errorMsg");
      const newPass = document.getElementById("newPass");
      const confirmPass = document.getElementById("confirmPass");

      function showError(msg) {
        errorMsg.textContent = msg;
        errorMsg.style.display = "block";
        newPass.classList.add("error");
        confirmPass.classList.add("error");
      }
      function clearError() {
        errorMsg.textContent = "";
        errorMsg.style.display = "none";
        newPass.classList.remove("error");
        confirmPass.classList.remove("error");
      }

      // Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ hoa và số
      const policy = /^(?=.*[A-Z])(?=.*\d).{8,}$/; // >=8, có chữ hoa & số

      btn.addEventListener("click", async () => {
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          clearError();

          const pass1 = newPass.value.trim();
          const pass2 = confirmPass.value.trim();

          // 1) Rỗng
          if (!pass1 || !pass2) return showError("Please fill in both fields.");

          // 2) Khớp nhau
          if (pass1 !== pass2) return showError("Passwords do not match!");

          // 3) Đúng policy
          if (!policy.test(pass1)) {
            return showError(
              "Password must be ≥8 chars, include an uppercase letter and a number."
            );
          }

          // 4) Token
          const token = sessionStorage.getItem("resetToken");
          if (!token)
            return showError(
              "Thiếu mã đặt lại mật khẩu (token). Vui lòng yêu cầu OTP lại."
            );

          try {
            btn.disabled = true;
            btn.textContent = "Processing...";

            const res = await fetch("/api/auth/reset-password", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ token, password: pass1 }),
            });
            const data = await res.json();

            if (res.ok && data.success) {
              sessionStorage.removeItem("resetToken");
              sessionStorage.removeItem("resetEmail");
              alert("Password has been reset successfully!");
              window.location.href = "/login";
            } else {
              showError(data.message || "Đặt lại mật khẩu thất bại");
            }
          } catch (e) {
            console.error("Reset password error:", e);
            showError("Có lỗi xảy ra. Vui lòng thử lại.");
          } finally {
            btn.disabled = false;
            btn.textContent = "Confirm";
          }
        });
      });
    </script>
  </main>
</body>

</html>